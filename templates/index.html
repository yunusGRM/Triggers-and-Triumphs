{% extends "base.html" %}
{% block content %}

  <!-- Hero -->
  <section class="mb-8 md:mb-10">
    <div class="glass border border-zinc-200 rounded-xl2 shadow-glow p-6 md:p-8 relative overflow-hidden">
      <div class="absolute -top-24 -right-24 w-72 h-72 rounded-full bg-ochre/30 blur-2xl animate-pulseSoft"></div>
      <div class="absolute -bottom-28 -left-28 w-96 h-96 rounded-full bg-plum/20 blur-2xl animate-pulseSoft"></div>

      <div class="relative z-10 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
          <h2 class="font-serif text-3xl md:text-4xl leading-tight">Dark humor meets gentle healing.</h2>
          <p class="mt-2 text-zinc-700">Generate razor-sharp cards on demand. Screenshot, share, or print.</p>
        </div>
        <div class="text-sm bg-cream/70 border border-zinc-200 rounded-xl px-3 py-2 shadow-inner">
          Free cards left today: <span class="font-semibold">{{ remaining }}</span>
          <span class="text-zinc-500">
            {% if session.get('email') %}(per account){% else %}(per IP){% endif %}
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Generator form -->
  <form method="post" action="/generate"
        class="glass border border-zinc-200 rounded-xl2 shadow-glow p-6 md:p-7"
        onsubmit="this.querySelector('button[type=submit]').disabled=true">
    <div class="grid md:grid-cols-3 gap-4">
      <!-- Category -->
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select name="category" class="w-full border rounded-lg p-2 bg-white/80">
          {% for c in categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
        </select>
      </div>

      <!-- Tone -->
      <div>
        <label class="block text-sm font-medium mb-1">Tone</label>
        <select name="tone" class="w-full border rounded-lg p-2 bg-white/80">
          {% for t in tones or ['Classic','Sassy','Spicy','Extra Spicy'] %}
            <option value="{{ t }}" {% if t == 'Sassy' %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Theme -->
      <div>
        <label class="block text-sm font-medium mb-1">Optional theme</label>
        <input name="theme" placeholder="e.g., fear of failure, Sunday scaries"
               class="w-full border rounded-lg p-2 bg-white/80" />
      </div>
    </div>

    <div class="mt-4 flex items-center gap-3">
      <button type="submit" class="px-4 py-2 rounded-lg bg-ink text-white hover:opacity-90 shadow-glow">
        Generate Card
      </button>
      <a href="/buy" class="text-sm underline decoration-dotted underline-offset-4">Upgrade</a>
    </div>
  </form>

  <!-- Output -->
  {% if last %}
    {% set cat = (last.category or 'Trigger') | lower %}
    {% set ring =
      'ring-ochre/70' if cat=='trigger' else
      'ring-moss/70' if cat=='coping' else
      'ring-sky/70' if cat=='healing' else
      'ring-plum/70' %}
    {% set badge =
      'bg-ochre/20 text-ink border-ochre/40' if cat=='trigger' else
      'bg-moss/20 text-ink border-moss/40' if cat=='coping' else
      'bg-sky/20 text-ink border-sky/40' if cat=='healing' else
      'bg-plum/20 text-ink border-plum/40' %}

    <section class="mt-8">
      <div id="cardToSave"
           class="bg-white rounded-xl2 p-8 shadow-glow ring-2 {{ ring }} border border-zinc-200 relative overflow-hidden">
        <!-- corner decor -->
        <div class="absolute -top-10 -right-10 w-32 h-32 rounded-full bg-cream opacity-70"></div>

        <div class="text-[11px] uppercase tracking-widest inline-flex items-center gap-2 px-3 py-1 rounded-full border {{ badge }} mb-4">
          <span>‚óè</span> {{ last.category }}
        </div>

        <h3 class="font-serif text-3xl leading-tight mb-2">{{ last.title }}</h3>
        <p class="text-zinc-600 mb-5">{{ last.subtitle }}</p>
        <p class="text-lg leading-relaxed">{{ last.body }}</p>

        {% if last.tags %}
          <div class="mt-6 flex flex-wrap gap-2">
            {% for tag in last.tags %}
              <span class="text-xs bg-fog border border-zinc-300 px-2 py-1 rounded-full">#{{ tag }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="mt-4 flex flex-wrap items-center gap-2">
        <button id="downloadBtn"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Download PNG</button>
        <button id="copyBtn"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Copy text</button>

        <span class="mx-1 text-zinc-400">‚Ä¢</span>

        <button id="shareX"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Share on X</button>
        <button id="shareLinkedIn"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Share on LinkedIn</button>
        <button id="copyLink"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Copy link</button>
        <button id="nativeShare"
                class="px-3 py-2 rounded-lg border border-zinc-300 bg-white hover:bg-zinc-50">Share‚Ä¶</button>
      </div>

      <p class="mt-2 text-xs text-zinc-500">
        PNGs include a tiny watermark so people can find the generator. üíÖ
      </p>
    </section>
  {% endif %}

  {% if last %}
  <script>
    // Safely expose the last card to JS
    const LAST_CARD = {{ last | tojson }};

    // --------- Helpers ---------
    function buildShareText() {
      const title = LAST_CARD?.title || '';
      const subtitle = LAST_CARD?.subtitle || '';
      const body = LAST_CARD?.body || '';
      // short, tweet-friendly blurb
      const blurb = `${title} ‚Äî ${subtitle}`.trim();
      // add a fun hashtag
      const hash = "#TriggersAndTriumphs";
      return `${blurb}\n\n${hash}`;
    }

    function currentPageUrl() {
      // Clean URL without query params, plus lightweight UTM tags
      const origin = window.location.origin;
      const path = window.location.pathname.replace(/\/+$/, "") || "/";
      const utm = "?utm_source=share&utm_medium=card&utm_campaign=viral";
      return origin + path + utm;
    }

    function openNew(url) {
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // Copy text fallback (works on non-HTTPS too)
    async function copyWithFallback(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (_) {}
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'absolute';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (_) {
        return false;
      }
    }

    // Add a subtle watermark to PNG export
    function watermarkCanvas(canvas) {
      const ctx = canvas.getContext('2d');
      const pad = Math.round(canvas.width * 0.02); // 2% padding
      const url = "triggers-and-triumphs.onrender.com";
      ctx.save();
      ctx.globalAlpha = 0.75;
      ctx.font = `${Math.max(14, Math.floor(canvas.width * 0.016))}px Inter, system-ui, -apple-system, sans-serif`;
      ctx.fillStyle = "rgba(0,0,0,0.75)";
      // background pill for readability
      const textWidth = ctx.measureText(url).width;
      const textHeight = Math.max(18, Math.floor(canvas.width * 0.02));
      const x = canvas.width - textWidth - pad * 1.2;
      const y = canvas.height - pad;
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      const radius = Math.floor(textHeight / 2);
      const w = textWidth + pad * 0.8;
      const h = textHeight + pad * 0.2;
      // rounded rect
      ctx.beginPath();
      ctx.moveTo(x - pad*0.4 + radius, y - h);
      ctx.arcTo(x - pad*0.4 + w, y - h, x - pad*0.4 + w, y, radius);
      ctx.arcTo(x - pad*0.4 + w, y, x - pad*0.4, y, radius);
      ctx.arcTo(x - pad*0.4, y, x - pad*0.4, y - h, radius);
      ctx.arcTo(x - pad*0.4, y - h, x - pad*0.4 + w, y - h, radius);
      ctx.closePath();
      ctx.fill();

      // text
      ctx.fillStyle = "rgba(0,0,0,0.8)";
      ctx.fillText(url, x, y - h/2 + 5);
      ctx.restore();
      return canvas;
    }

    // --------- Actions ---------
    document.addEventListener('click', async (e) => {
      // PNG export (with watermark)
      if (e.target.id === 'downloadBtn') {
        const node = document.getElementById('cardToSave');
        if (!node) return;
        const canvas = await html2canvas(node, { backgroundColor: null, scale: 2 });
        watermarkCanvas(canvas);
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = (LAST_CARD?.title || 'triggers-card') + '.png';
        link.click();
      }

      // Copy text
      if (e.target.id === 'copyBtn') {
        const text = `„Äê${LAST_CARD?.title || ''}„Äë\n${LAST_CARD?.subtitle || ''}\n\n${LAST_CARD?.body || ''}\n\n‚Äî made at triggers-and-triumphs.onrender.com`;
        const ok = await copyWithFallback(text);
        if (ok) { e.target.textContent = 'Copied!'; setTimeout(() => (e.target.textContent = 'Copy text'), 1200); }
        else { alert('Copy failed ‚Äî please select and copy manually.'); }
      }

      // Share on X/Twitter
      if (e.target.id === 'shareX') {
        const text = buildShareText();
        const url = currentPageUrl();
        const share = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
        openNew(share);
      }

      // Share on LinkedIn
      if (e.target.id === 'shareLinkedIn') {
        const url = currentPageUrl();
        const share = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
        openNew(share);
      }

      // Copy link
      if (e.target.id === 'copyLink') {
        const ok = await copyWithFallback(currentPageUrl());
        if (ok) { e.target.textContent = 'Link copied!'; setTimeout(() => (e.target.textContent = 'Copy link'), 1200); }
        else { alert('Copy failed ‚Äî please copy the URL from the address bar.'); }
      }

      // Native share sheet (mobile & modern browsers)
      if (e.target.id === 'nativeShare') {
        const title = LAST_CARD?.title || 'Triggers & Triumphs';
        const text = buildShareText();
        const url = currentPageUrl();
        if (navigator.share) {
          try {
            await navigator.share({ title, text, url });
          } catch (_) {}
        } else {
          // Fallback to copying link
          const ok = await copyWithFallback(url);
          if (ok) { e.target.textContent = 'Link copied!'; setTimeout(() => (e.target.textContent = 'Share‚Ä¶'), 1200); }
          else { openNew(url); }
        }
      }
    });
  </script>
  {% endif %}
{% endblock %}
